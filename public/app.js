document.addEventListener('DOMContentLoaded', () => {
  const issueTextarea = document.getElementById('issue');
  const ruleTextarea = document.getElementById('rule');
  const applicationTextarea = document.getElementById('application');
  const conclusionTextarea = document.getElementById('conclusion');
  const preview = document.getElementById('preview');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');

  const textareas = [issueTextarea, ruleTextarea, applicationTextarea, conclusionTextarea];

  function loadFromStorage() {
    textareas.forEach(textarea => {
      const saved = localStorage.getItem(`irac-${textarea.id}`);
      if (saved) {
        textarea.value = saved;
      }
    });
    updatePreview();
  }

  function saveToStorage() {
    textareas.forEach(textarea => {
      localStorage.setItem(`irac-${textarea.id}`, textarea.value);
    });
  }

  function updatePreview() {
    const issue = issueTextarea.value.trim();
    const rule = ruleTextarea.value.trim();
    const application = applicationTextarea.value.trim();
    const conclusion = conclusionTextarea.value.trim();

    if (!issue && !rule && !application && !conclusion) {
      preview.innerHTML = '<p class="placeholder-text">Your IRAC analysis will appear here as you type...</p>';
      return;
    }

    let html = '';

    if (issue) {
      html += `
        <div class="preview-item">
          <div class="preview-label">Issue:</div>
          <div class="preview-text">${escapeHtml(issue)}</div>
        </div>
      `;
    }

    if (rule) {
      html += `
        <div class="preview-item">
          <div class="preview-label">Rule:</div>
          <div class="preview-text">${escapeHtml(rule)}</div>
        </div>
      `;
    }

    if (application) {
      html += `
        <div class="preview-item">
          <div class="preview-label">Application:</div>
          <div class="preview-text">${escapeHtml(application)}</div>
        </div>
      `;
    }

    if (conclusion) {
      html += `
        <div class="preview-item">
          <div class="preview-label">Conclusion:</div>
          <div class="preview-text">${escapeHtml(conclusion)}</div>
        </div>
      `;
    }

    preview.innerHTML = html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function clearAll() {
    if (confirm('Are you sure you want to clear all fields?')) {
      textareas.forEach(textarea => {
        textarea.value = '';
        localStorage.removeItem(`irac-${textarea.id}`);
      });
      updatePreview();
    }
  }

  function exportAnalysis() {
    const issue = issueTextarea.value.trim();
    const rule = ruleTextarea.value.trim();
    const application = applicationTextarea.value.trim();
    const conclusion = conclusionTextarea.value.trim();

    if (!issue && !rule && !application && !conclusion) {
      alert('Please fill in at least one section before exporting.');
      return;
    }

    const text = `IRAC LEGAL ANALYSIS
${'='.repeat(50)}

ISSUE:
${issue || '[Not provided]'}

RULE:
${rule || '[Not provided]'}

APPLICATION:
${application || '[Not provided]'}

CONCLUSION:
${conclusion || '[Not provided]'}

${'='.repeat(50)}
Generated by IRAC Visualizer - ${new Date().toLocaleDateString()}
`;

    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `irac-analysis-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  textareas.forEach(textarea => {
    textarea.addEventListener('input', () => {
      updatePreview();
      saveToStorage();
    });
  });

  clearBtn.addEventListener('click', clearAll);
  exportBtn.addEventListener('click', exportAnalysis);

  loadFromStorage();
});
